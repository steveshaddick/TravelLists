function Location(t,e){this.name=t.name,this.id=t.id,this.listOrder=t.listOrder,this.lat=t.lat,this.lng=t.lng,this.isOpen=!0,this.totalNotes=0,this.topOffset=this.bottomOffset=0,this.hash="",this.text=[],this.text.suggestCTA="",this.text.noteTextPlaceholder="",this.$element=null,this.$notesElement=null,this.$showHideButton=null,this.$noteText=null,this.$noteEditor=null,this.notes=[];var e=e===void 0?!1:e;this.$element=$("#clsLocation").clone(!0).attr("id","location_"+this.id),this.$element.html(this.$element.html().replace(/\$LOCATION\$/g,this.name).replace(/\$LOCATION_ID\$/g,this.id)),this.$element.attr("data-order",this.listOrder),this.hash=this.name.indexOf(",")>-1?this.name.substring(0,this.name.indexOf(",")):this.name,$(".anchor",this.$element).attr("id",this.hash),this.$noteText=$(".txtNoteText",this.$element),this.$noteEditor=$(".note-editor",this.$element),this.text.suggestCTA=$(".note-text-label",this.$element).html();var o=Math.floor(10*Math.random());switch(this.text.noteTextPlaceholder="ex. You've got to try the skybar!",o){case 0:this.text.noteTextPlaceholder="ex. There's a great hostel called Best Hostel Ever.";break;case 1:this.text.noteTextPlaceholder="ex. Go to Mindy's and order the soup.";break;case 2:this.text.noteTextPlaceholder="ex. Contemporary art gallery. Don't miss it."}this.$noteText.attr("placeholder",this.text.noteTextPlaceholder).focus({location:this},this.noteTextFocus),this.$showHideButton=$(".show-hide-link",this.$element),this.$showHideButton.click({location:this},this.showHide);var n=$("#locations > .location");if(0===n.length||e)$("#locations").append(this.$element);else{var i=this,a=!1;n.each(function(){a||$(this).attr("data-order")>i.listOrder&&($(this).before(i.$element),a=!0)}),a||$("#locations").append(this.$element)}this.$notesElement=$(".notes-wrapper",this.$element);for(var l=0,s=t.notes.length;s>l;l++)this.addNote(t.notes[l])}var Ajax=function(){function t(t){l=t}function e(t,e,h,f,v){if(v=v===void 0?!1:v,e===void 0?e={token:l}:e.token=l,v)e.bgid=m++,p.push({bgid:e.bgid,callback:h===void 0?null:h,errorCallback:f===void 0?null:f});else{if(s)return;d=h===void 0?null:h,u=f===void 0?null:f,r=setTimeout(i,a)}c=$.ajax({url:"/ajax/"+t,type:"POST",data:e,dataType:"json"}),c.done(o),c.fail(n)}function o(t){if(t&&t.success)if(t.bgid)for(var e=p.length-1;e>=0;e--)p[e].bgid==t.bgid&&(p[e].callback&&p[e].callback(t),p.splice(e,1));else s=!1,c=null,clearTimeout(r),d&&(d(t),d=null,u=null);else if(t&&t.bgid)for(var e=p.length-1;e>=0;e--)p[e].bgid==t.bgid&&(p[e].errorCallback&&p[e].errorCallback(t),p.splice(e,1));else n()}function n(){s=!1,c=null,d=null,clearTimeout(r),u&&(u(),u=null)}function i(){c.done(function(){}),c.fail(function(){}),n()}var a=1e4,l="none",s=!1,r=null,c=null,d=null,u=null,p=[],m=1;return{init:t,call:e}}(),EventDispatcher=function(){function t(t,e){n[t]===void 0&&(n[t]=[]);for(var o=0;n[t].length>o;o++)if(n[t][o]==e)return;n[t].push(e)}function e(t,e){if(void 0!==n[t]){for(var o=n[t].length-1;o>=0;o--)n[t][o]==e&&n[t].splice(o,1);0===n[t].length&&(n[t]=void 0)}}function o(t,e){if(void 0!==n[t])for(var o=0;1>o;o++)n[t][o](e)}var n=[];return{addEventListener:t,removeEventListener:e,dispatchEvent:o}}(),Modal=function(){function t(t,e,n){a=e,s=!0,l=n,$("#modal").css("display","block"),$("#modalContent").load(t,{},o)}function e(){l!==void 0&&$("#modalContent").removeClass(l),s=!1,l=!1,$("#modalContent").html(""),$("#modal").css("display","none"),$(document).unbind("keydown",n),$("#modalUnder").unbind("click",i)}function o(){s&&(l!==void 0&&$("#modalContent").addClass(l),a!==void 0&&(a(),a=!1),$(document).keydown(n),$("#modalUnder").click(i))}function n(t){switch(t.which){case 27:e()}}function i(){return e(),!1}var a,l,s=!1;return{load:t,close:e}}(),TransitionController=function(){function t(t,o){void 0!==o&&(""===e&&(e=$.browser.webkit?"webkitTransitionEnd":$.browser.msie?"msTransitionEnd":$.browser.mozilla?"transitionend":$.browser.opera?"oTransitionEnd":"none"),Modernizr.csstransitions&&"none"!==e?(t.unbind(e),t.bind(e,function(){t.unbind(e),o(t)})):o(t))}var e="";return{transitionEnd:t}}();Location.prototype.destroy=function(){},Location.prototype.addNote=function(t,e){var o=$("#clsNote").clone().attr("id","note_"+t.id);e=e===void 0?!1:e,t.canDelete&&$(".note-delete a",o).removeClass("edit-mode").click({location:this,noteId:t.id},this.deleteNoteClickHandler),t.$element=o,this.notes[t.id]=t,t.linkCheck<=(new Date).valueOf()/1e3&&Main.queueLinkCheck(this,t.id,t.linkUrl),this.parseNote(t.id),this.$notesElement.append(o),this.isOpen&&e&&o.hide().show("slow"),this.$showHideButton.removeClass("hidden"),this.totalNotes++,t.id>GLOBAL.lastNote&&(GLOBAL.lastNote=t.id)},Location.prototype.parseNote=function(t,e){var o=this.notes[t];e!==void 0&&(o.linkTitle=e.linkTitle,o.linkImage=e.linkImage,o.linkDescription=e.linkDescription);var n,i=o.note;switch(""!=o.linkUrl?""!=o.linkImage||""!=o.linkDescription?($(".link-title",o.$element).attr("href",o.linkUrl).html(o.linkTitle),i==o.linkUrl?$(".note-text",o.$element).css("display","none"):$(".note-text",o.$element).css("display",""),$(".note-link",o.$element).css("display",""),""!=o.linkImage?$(".link-image",o.$element).attr("src",o.linkImage).parent().attr("href",o.linkUrl):$(".link-image",o.$element).addClass("hidden"),""!=o.linkDescription&&$(".link-description",o.$element).html(o.linkDescription)):$(".note-link",o.$element).css("display","none"):$(".note-link",o.$element).css("display","none"),n=/(\(?\bhttps?:\/\/[-A-Za-z0-9+&@#\/%?=~_()|!:,.;]*[-A-Za-z0-9+&@#\/%=~_()|])/g,i=i.replace(n,'<a target="_blank" href="$1">$1</a>').replace(/href="\(/g,'href="').replace(/\)">/g,'">'),o.categoryId){case"1":$(".note-category",o.$element).addClass("stay");break;case"2":$(".note-category",o.$element).addClass("food");break;case"3":$(".note-category",o.$element).addClass("poi")}""==o.fromName&&(o.fromName="Anonymous"),$(".note-text",o.$element).html(i),$(".note-from",o.$element).html("-"+o.fromName)},Location.prototype.deleteNoteClickHandler=function(t){var e=t.data.location,o=e.notes[t.data.noteId];return void 0!==o&&o.canDelete?(Ajax.call("deleteNote",{noteId:o.id,noteCookie:GLOBAL.noteCookie},function(){$("#note_"+o.id).remove(),delete e.notes[o.id],e.totalNotes--},function(){}),!1):void 0},Location.prototype.showHide=function(t){var e=t.data.location;return e.isOpen?(e.cancelNote(),$(".notes-hidden .number",e.$element).html(e.totalNotes),$(".notes-wrapper",e.$element).slideUp(),$(".notes-hidden",e.$element).show(),e.isOpen=!1,e.$showHideButton.html("+").attr("title","Expand")):($(".notes-wrapper",e.$element).slideDown(),$(".notes-hidden",e.$element).hide(),e.isOpen=!0,e.$showHideButton.html("&#150;").attr("title","Collapse")),!1},Location.prototype.noteTextFocus=function(t){var e=t.data.location;GLOBAL.activeNoteLocation!==e&&(GLOBAL.activeNoteLocation&&GLOBAL.activeNoteLocation.cancelNote(),e.editNote())},Location.prototype.noteTextBlur=function(){},Location.prototype.editNote=function(){var t=this;GLOBAL.activeNoteLocation=this,$(".note-text-label",this.$element).addClass("hidden"),this.$noteText.attr("placeholder","").addClass("editing"),this.$noteText.keyup(function(e){return 27==e.which?(t.cancelNote(),void 0):(13==e.which&&(""==$("#txtFromName").val()?$("#txtFromName").focus():t.submitNote()),void 0)}),$(".category-wrapper",this.$element).append($("#clsCategorySelector")),$(".note-editor-bottom",this.$element).append($("#clsNoteFrom")).append($("#clsSubmitNote")),$("#txtFromName").keyup(function(e){return 27==e.which?(t.cancelNote(),void 0):(13==e.which&&t.submitNote(),void 0)}),$("#submitNoteButton").click(function(){return t.submitNote(),!1}),$("#cancelNoteButton").click(function(){return t.cancelNote(),!1})},Location.prototype.cancelNote=function(){GLOBAL.activeNoteLocation=null,this.$noteEditor.off("focusout"),$(".note-text-label",this.$element).removeClass("hidden"),this.$noteText.attr("placeholder",this.text.noteTextPlaceholder).removeClass("editing").unbind("keyup").val("").blur(),$("#cls").append($("#clsCategorySelector")).append($("#clsNoteFrom")).append($("#clsSubmitNote")),$("#txtFromName").unbind("keyup"),$("#submitNoteButton").unbind("click"),$("#cancelNoteButton").unbind("click")},Location.prototype.submitNote=function(){var t=$.trim(this.$noteText.val()),e=$("#selCategory").val(),o=$.trim($("#txtFromName").val());if(""==t)return this.cancelNote(),void 0;if(""==o&&(o="Anonymous"),$.cookie("from",o,{expires:365,path:"/"}),!GLOBAL.noteCookie){GLOBAL.noteCookie="";for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;10>i;i++)GLOBAL.noteCookie+=n.charAt(Math.floor(Math.random()*n.length));GLOBAL.noteCookie+=(new Date).valueOf()}$(".blocker",this.$element).removeClass("hidden");var a=this;Ajax.call("addNote",{noteText:t,fromName:o,categoryId:e,locationId:this.id,noteCookie:GLOBAL.noteCookie},function(t){a.cancelNote(),$(".blocker",this.$element).addClass("hidden"),t.categoryId=e,a.addNote(t)},function(){a.cancelNote(),$(".blocker",this.$element).addClass("hidden")})};var Trip=function(){function t(t){$("body select").msDropDown(),Ajax.call("loadTrip",{},function(t){for(var n=0,i=t.locations.length;i>n;n++)i-1>n?o(t.locations[n],!0):o(t.locations[n]);h=t.tripName,f=t.tripAuthor,v=t.email,$("#editTripButton").click(s),GLOBAL.isAdmin&&ListAdmin.init(t.notices),Main.poll(),e()},function(){}),c=new google.maps.LatLngBounds;var n={center:new google.maps.LatLng(t.lat,t.lng),zoom:4,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,disableDoubleClickZoom:!0,scrollwheel:!1};r=new google.maps.Map(document.getElementById("map"),n),$.cookie("from")&&$("#txtFromName").val($.cookie("from")),u=$("#stickyLocation"),d=$(document),$(window).scroll(e)}function e(){if(k)return b=!0,void 0;var t=d.scrollTop(),o="";for(var n in p){if(t>p[n].location.$element.offset().top+50&&p[n].location.$element.offset().top+p[n].location.$element.height()-200>t){o=p[n].location.name;break}o=""}o!=L&&(L=o,""!=o?(u.css("top",0),$(".location-name",u).html(o).attr("href","#"+p[n].location.hash)):u.css("top","")),b=!1,k=!0,setTimeout(function(){k=!1,b&&e()},50)}function o(t,e){var o=new Location(t),n=null;if(0!=o.lat&&0!=o.lng){var i={animation:google.maps.Animation.DROP,position:new google.maps.LatLng(o.lat,o.lng),title:o.name};n=new google.maps.Marker(i),google.maps.event.addListener(n,"click",function(){var t=o.$element.offset().top;$("html, body").animate({scrollTop:t},500)}),n.setMap(r),c.extend(i.position)}p[o.id]={location:o,marker:n},m++,t.id>GLOBAL.lastLocation&&(GLOBAL.lastLocation=t.id),e===void 0&&(m>1?r.fitBounds(c):r.setCenter(i.position))}function n(t,e){p[t.locationId]!==void 0&&p[t.locationId].location.addNote(t,e)}function i(t){if($("#location_"+t).remove(),p[t].marker&&p[t].marker.setMap(null),p[t].location.destroy(),p.splice(t,1),m--,m>1){c=new google.maps.LatLngBounds;for(var e in p)p[e].marker&&(c.extend(p[e].marker.getPosition()),r.fitBounds(c))}}function a(t,e){var o=$("#location_"+t),n=parseInt(o.attr("data-order")),i=e?n-1:n+1;if(!(1>i||i>m)){var a=$(".location").filter(function(){return $.attr(this,"data-order")==i});Ajax.call("reorderLocation",{currentLocation:t,swapLocation:a.attr("id").replace("location_",""),newOrder:i,swapOrder:n},function(){a.attr("data-order",n),o.attr("data-order",i),e?a.before(o):a.after(o)},function(){})}}function l(){return{tripName:h,tripAuthor:f}}function s(){return EditModeModal.open(),!1}var r,c,d,u,p=[],m=0,h="",f="",v="",k=!1,b=!0,L="";return{loadTrip:t,addLocation:o,addNote:n,deleteLocation:i,reorderLocation:a,getTripInfo:l}}(),EditModeModal=function(){function t(){Modal.load("/views/modal/enterEmail.html",n,"email-modal")}function e(t){var e=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return e.test(t)}function o(){var t=!0;""==$.trim(r.val())&&(t=!1),r.hasClass("error")&&(r.removeClass("error"),$("#errorReturn").addClass("hidden")),t?c.removeClass("hidden"):c.addClass("hidden")}function n(){c=$("#emailAdmin"),r=$("#txtEmail"),d=!1,r.keyup(o).focus(),c.click(i),$("#isRemember").click(a),$(document).keyup(l),$("#oopsLink").click(s),$.cookie("email")?($("#isRemember").prop("checked",!0),r.val($.cookie("email"))):c.focus(),o()}function i(){if(!d){var t=r.val();return e(t)?(d=!0,$("#isRemember").is(":checked")&&$.cookie("email",t,{expires:365,path:"/"}),Ajax.call("checkEditMode",{email:t},function(){EditMode.init(),s()},function(){r.addClass("error"),$("#errorReturn").removeClass("hidden"),d=!1}),!1):(r.addClass("error"),void 0)}}function a(){$("#isRemember").is(":checked")||$.removeCookie("email",{path:"/"})}function l(t){switch(t.which){case 13:i()}}function s(){r.unbind("keyup",o),c.unbind("click",i),$("#isRemember").unbind("click",a),$(document).unbind("keyup",l),c=null,r=null,d=!1,Modal.close()}var r,c,d=!1;return{open:t,close:s}}(),EditMode=function(){function t(){$(".edit-mode").removeClass("edit-off"),GLOBAL.activeNoteLocation&&GLOBAL.activeNoteLocation.cancelNote(),$(".add-note").addClass("hidden"),$("header").addClass("edit-on"),$("#map").addClass("edit-on"),$("#addLocationButton").click(o),$(document).on("click",".delete-location-button",i).on("click",".location-up",a).on("click",".location-down",a),$("#editDoneButton").click(e),s=new EditText($("#tripTitle"),function(){l({tripTitle:$("#tripTitle").html()})}),r=new EditText($("#tripSubtitle"),function(){l({tripSubtitle:$("#tripSubtitle").html()})}),$("#editBar").slideDown()}function e(){return Ajax.call("closeEditMode"),$(".edit-mode").addClass("edit-off"),$(".add-note").removeClass("hidden"),$("header").removeClass("edit-on"),$("#map").removeClass("edit-on"),$("#addLocationButton").unbind("click"),$(document).unbind("click"),$("#editDoneButton").unbind("click"),s.destroy(),r.destroy(),$("#editBar").slideUp(),!1}function o(){return $("html, body").scrollTop(0),Modal.load("/views/modal/addLocation.html",function(){var t={types:["(regions)"]};c=new google.maps.places.Autocomplete(document.getElementById("txtLocation"),t),$(".submitLocationLink").click(n)}),!1}function n(){var t=$("#txtLocation").val();$("#txtLocation").prop("disabled",!0),Ajax.call("addLocation",{location:t},function(t){c=null,$(".submitLocationLink").unbind("click"),Modal.close(),Trip.addLocation(t)},function(){$("#txtLocation").val(""),$("#txtLocation").prop("disabled",!1)})}function i(){var t=$(this).attr("data-id");return Ajax.call("deleteLocation",{locationId:t},function(){Trip.deleteLocation(t)},function(){}),!1}function a(t){var e=$(this).attr("data-id");return Trip.reorderLocation(e,$(t.target).hasClass("location-up")?!0:!1),!1}function l(t){Ajax.call("saveTrip",t)}var s,r,c=null;return{init:t,dinit:e}}(),EditText=function(t,e){this.$element=t,this.saveCallback=e,this.$divWrapper=$('<div><input type="text" disabled="disabled" class="editTextInput" /></div>'),this.$divWrapper.attr("class",this.$element.attr("class")),this.$input=$(".editTextInput",this.$divWrapper).css("display","none"),this.$element.after(this.$divWrapper),this.$divWrapper.append(this.$element),this.$input.val(this.$element.html()),this.$divWrapper.click({editText:this},this.onClickHandler)};EditText.prototype.onClickHandler=function(t){var e=t.data.editText;e.$input.css("display","").prop("disabled",!1).attr("class","editTextInput "+e.$element.attr("class")),e.$element.css("display","none"),e.$divWrapper.unbind("click"),e.$input.select().blur({editText:e},e.finishText).keypress({editText:e},e.onKeypress)},EditText.prototype.onKeypress=function(t){var e=t.keyCode?t.keyCode:t.which,o=t.data.editText;switch(e){case 13:o.finishText(t);break;case 27:o.$input.val(o.$element.html()),t.data.noSave=!0,o.finishText(t)}},EditText.prototype.finishText=function(t){var e=t.data.editText;e.$input.prop("disabled",!0).unbind("blur").unbind("keypress").css("display","none"),e.$element.css("display","").html(e.$input.val()),e.$divWrapper.click({editText:e},e.onClickHandler),t.data.noSave===void 0&&e.saveCallback()},EditText.prototype.destroy=function(){this.$element=null,this.saveCallback=null,this.$divWrapper.unbind("click"),this.$divWrapper=null,this.$input=null};var Home=function(){function t(t){switch($(".next-button").click(d),$(".back-button").click(c),$(".create-button").click(d),t){case"lost":b=$("#lostTripPage"),L=$("#sentEmailPage"),g=b,s();break;default:v=$("#infoPage"),k=$("#locationPage"),g=k,a()}$(document).keydown(function(t){switch(t.which){case 13:d()}})}function e(t){var e=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return e.test(t)}function o(){for(var t=!0,e=0,o=x.length;o>e;e++)""==$.trim(x[e].val())&&(t=!1),x[e].hasClass("error")&&x[e].removeClass("error");t?f.removeClass("hidden"):f.addClass("hidden")}function n(){C=!1,x=[$("#txtName"),$("#txtEmail")],x[0].prop("disabled",!1).keyup(o).focus(),x[1].prop("disabled",!1).keyup(o),f=$(".next-button",v),$(".back-button",v).removeClass("hidden"),o()}function i(){x[0].prop("disabled",!0).unbind("keyup"),x[1].prop("disabled",!0).unbind("keyup"),x[0].val($.trim(x[0].val())),x[1].val($.trim(x[1].val())),f.addClass("hidden"),$(".back-button",v).addClass("hidden")}function a(){C=!1,x=[$("#txtLocation")],x[0].prop("disabled",!1).keyup(o).focus(),f=$(".next-button",k),o();var t={types:["(regions)"]};new google.maps.places.Autocomplete(x[0][0],t)}function l(){x[0].prop("disabled",!0).unbind("keyup"),f.addClass("hidden")}function s(){C=!1,x=[$("#txtEmail")],x[0].prop("disabled",!1).keyup(o).focus(),f=$(".next-button",b)}function r(){x[0].val($.trim(x[0].val())),x[0].prop("disabled",!0).unbind("keyup")}function c(){if(!C){C=!0;var t;switch(g.removeClass("page-current").addClass("page-right"),g){case v:i(),g=k,t=a}return g.removeClass("page-left").addClass("page-current"),TransitionController.transitionEnd(g,t),!1}}function d(){if(!C){if(!f.hasClass("hidden")){var t;switch(g){case v:if(!e(x[1].val()))return x[1].addClass("error"),void 0;C=!0,g.removeClass("page-current").addClass("page-left"),i(),$(".trip-subtitle").html("by "+x[0].val()),$(".email").html(x[1].val()),u();break;case k:C=!0,g.removeClass("page-current").addClass("page-left"),l(),$(".trip-title").html(x[0].val()),g=v,t=n;break;case b:if(!e(x[0].val()))return x[0].addClass("error"),void 0;p()}return g.removeClass("page-right").addClass("page-current"),TransitionController.transitionEnd(g,t),!1}if(x&&x.length>1)for(var o=0,a=x.length-1;a>o;o++)if(x[o].is(":focus")){x[o+1].focus();break}}}function u(){var t=$("#txtName").val(),e=$("#txtEmail").val(),o=$("#txtTripName").val(),n=$("#txtLocation").val();Main.loadBlock(),Ajax.call("createTrip",{name:t,email:e,tripName:o,location:n},m)}function p(){var t=$("#txtEmail").val();return e(t)?(Main.loadBlock(),Ajax.call("sendEmail",{adminEmail:t},h),void 0):($("#txtEmail").addClass("error"),void 0)}function m(t){t.success?window.location="/"+t.tripHash:alert("ERROR!")}function h(t){return Main.loadRelease(),"no trips"==t.message?(alert("No trips were found."),void 0):(C=!0,g.removeClass("page-current").addClass("page-left"),r(),g=L,g.removeClass("page-right").addClass("page-current"),void 0)}var f=null,v=null,k=null,b=null,L=null,g=null,x=[],C=!1;return{init:t}}();"undefined"==typeof console&&(console={log:function(){}});var GLOBAL={isAdmin:!1,polltime:15e3,lastLocation:0,lastNote:0,lastNotice:0,activeNoteLocation:null,noteCookie:!1},Notice=function(){function t(t,o){o=o===void 0?!1:o,a.unshift(t),t._id>GLOBAL.lastNotice&&(GLOBAL.lastNotice=t._id),o||e()}function e(){l||(s=$("#noticeContainer"),s.css("display","block"),l=$(".notice",s),r=s.offset().top,c=$(document),$(window).scroll(n)),n(),l.removeClass("down").addClass("up"),$(".notice-text",l).html(a[0].notice),$(".delete-link",l).unbind("click"),setTimeout(function(){l.removeClass("up"),TransitionController.transitionEnd(l,function(){$(".delete-link",l).bind("click",o)})},1)}function o(){$(".delete-link",l).unbind("click"),l.removeClass("up").addClass("down"),TransitionController.transitionEnd(l,function(){i()}),Ajax.call("deleteNotice",{noticeId:a[0]._id},null,null,!0)}function n(){d||(c.scrollTop()>=r?s.addClass("fixed"):s.removeClass("fixed"),d=!0,setTimeout(function(){d=!1},50))}function i(){a.shift(),a.length>0?e():(s.css("display","none"),l=null,s=null,$(window).unbind("scroll",n))}var a=[],l=null,s=null,r=0,c=null,d=!1;return{addNotice:t}}(),Settings=function(){function t(){$("txtTripName").val()}function e(){o?t():close()}var o=!1;return{toggleSettings:e}}(),Main=function(){function t(t){Ajax.init(t.a),GLOBAL.isAdmin=t.isAdmin,GLOBAL.noteCookie=t.noteCookie,$("#shareTripButton").click(r)}function e(){$("#loadBlocker").css("display","block")}function o(){$("#loadBlocker").css("display","none")}function n(t,e,o){""!=o&&(c.push({location:t,noteId:e,url:o}),i())}function i(){if(0!=c.length){var t=c[0];Ajax.call("checkLink",{noteId:t.noteId,url:t.url},function(e){t.location.parseNote(t.noteId,e),i()},function(){i()},!0),c.shift()}}function a(){setTimeout(l,GLOBAL.polltime)}function l(){Ajax.call("poll",{lastLocation:GLOBAL.lastLocation,lastNote:GLOBAL.lastNote,lastNotice:GLOBAL.lastNotice,polltime:GLOBAL.polltime},s,s,!0)}function s(t){if(t&&t.success){GLOBAL.polltime=t.polltime?t.polltime:GLOBAL.polltime;var e;for(e=0;t.locations.length>e;e++)Trip.addLocation(t.locations[e]);for(e=0;t.notes.length>e;e++)Trip.addNote(t.notes[e],!0);if(GLOBAL.isAdmin)for(e=0;t.notices.length>e;e++)Notice.addNotice(t.notices[e])}a()}function r(){return Modal.load("/views/modal/shareTrip.html",function(){$(".text-box",$("#modalContent")).val("http://"+window.location.hostname+window.location.pathname).select(),$("#doneButton").click(function(){$("#doneButton").unbind("click"),Modal.close()})},"share-modal"),!1}var c=[];return{init:t,loadBlock:e,loadRelease:o,queueLinkCheck:n,poll:a}}();